# GitHub Actions: Repository Validation
# Runs validation checks on pushes and pull requests
#
# Component: risk-engine-js (Cor Prime Risk Engine)
# Last Updated: 2025-01-21

name: 'Repository Validation'

on:
  push:
    branches: [ main, 'feature/**', 'fix/**', 'docs/**', 'chore/**' ]
  pull_request:
    branches: [ main ]

jobs:
  validate-structure:
    name: 'Validate Repository Structure'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check required files
      run: |
        echo "ğŸ“ Checking required files..."

        REQUIRED_FILES=(
          "README.md"
          "package.json"
          ".gitignore"
          "CLAUDE.md"
          "AGENTS.md"
        )

        MISSING_FILES=()

        for file in "${REQUIRED_FILES[@]}"; do
          if [[ ! -f "$file" ]]; then
            echo "âŒ Missing: $file"
            MISSING_FILES+=("$file")
          else
            echo "âœ… Found: $file"
          fi
        done

        if [[ ${#MISSING_FILES[@]} -gt 0 ]]; then
          echo ""
          echo "âŒ ERROR: Missing required files"
          exit 1
        fi

        echo ""
        echo "âœ… All required files present"

    - name: Check TypeScript project structure
      run: |
        echo "ğŸ“¦ Checking TypeScript project structure..."

        # Check for tsconfig.json or next.config (Next.js project)
        if [[ ! -f "tsconfig.json" ]] && [[ ! -f "next.config.js" ]] && [[ ! -f "next.config.mjs" ]] && [[ ! -f "next.config.ts" ]]; then
          echo "âš ï¸  Warning: No tsconfig.json or next.config found"
        else
          echo "âœ… TypeScript/Next.js configuration found"
        fi

        # Check for src directory
        if [[ -d "src" ]]; then
          echo "âœ… src/ directory found"
        else
          echo "âš ï¸  Warning: No src/ directory found"
        fi

  validate-markdown:
    name: 'Validate Markdown Files'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install markdownlint
      run: npm install -g markdownlint-cli

    - name: Validate markdown syntax
      run: |
        echo "ğŸ“‹ Validating Markdown files..."

        # Run markdownlint with common exclusions
        if markdownlint . \
          --ignore node_modules \
          --ignore .next \
          --ignore dist \
          --ignore build \
          --ignore coverage > /tmp/markdownlint.log 2>&1; then
          echo "âœ… Markdown validation passed"
        else
          echo "âš ï¸  Markdown linting found issues (not blocking):"
          cat /tmp/markdownlint.log | head -20
          echo ""
          echo "Note: Markdown issues are warnings only"
        fi

  type-check:
    name: 'TypeScript Type Checking'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        if [[ -f "package-lock.json" ]]; then
          npm ci
        elif [[ -f "yarn.lock" ]]; then
          yarn install --frozen-lockfile
        else
          npm install
        fi

    - name: Run type check
      run: |
        echo "ğŸ” Running TypeScript type checking..."

        # Check if type-check script exists in package.json
        if grep -q '"type-check"' package.json; then
          npm run type-check
        elif grep -q '"tsc"' package.json; then
          npm run tsc
        else
          # Fallback: try running tsc directly if installed
          if command -v tsc &> /dev/null; then
            tsc --noEmit
          else
            echo "âš ï¸  No type-check command found in package.json"
            echo "   Skipping type checking"
          fi
        fi

        echo "âœ… Type checking passed"

  lint:
    name: 'Linting'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        if [[ -f "package-lock.json" ]]; then
          npm ci
        elif [[ -f "yarn.lock" ]]; then
          yarn install --frozen-lockfile
        else
          npm install
        fi

    - name: Run linter
      run: |
        echo "ğŸ” Running linter..."

        # Check if lint script exists
        if grep -q '"lint"' package.json; then
          npm run lint || {
            echo "âš ï¸  Linting found issues (not blocking)"
            exit 0
          }
        else
          echo "âš ï¸  No lint command found in package.json"
          echo "   Skipping linting"
        fi

        echo "âœ… Linting passed"

  summary:
    name: 'Validation Summary'
    runs-on: ubuntu-latest
    needs: [validate-structure, validate-markdown, type-check, lint]
    if: always()

    steps:
    - name: Check validation results
      run: |
        echo "ğŸ“Š Validation Summary"
        echo ""
        echo "All validation jobs completed"
        
        # This job will succeed if all dependent jobs succeeded
        # GitHub Actions will mark this as failed if any dependency failed
